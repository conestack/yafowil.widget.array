var yafowil_array=function(e,r){"use strict";class t{constructor(e){e.data("yafowil-array",this),this.wrapper=e;let t=r("> table",e),i=r("> thead .array_actions",t),a=this.add_first_handle.bind(this);this.table=t,r("a.array_row_add",i).off().on("click",a),this.bind_actions()}bind_actions(){let e=r("> tbody > tr > td.actions .array_actions",this.table),t=this.add_handle.bind(this),i=this.remove_handle.bind(this),a=this.up_handle.bind(this),s=this.down_handle.bind(this);this.mark_disabled(e),r("a.array_row_add",e).off().on("click",t),r("a.array_row_remove",e).off().on("click",i),r("a.array_row_up",e).off().on("click",a),r("a.array_row_down",e).off().on("click",s)}mark_disabled(e){r("a.array_row_up",e).removeClass("array_row_up_disabled").first().addClass("array_row_up_disabled"),r("a.array_row_down",e).removeClass("array_row_down_disabled").last().addClass("array_row_down_disabled")}create_row(){let e=this.wrapper.attr("class"),t="";t+="<tr>",t+='<td class="widget">',t+="</td>",-1===e.indexOf("array-static")&&(t+='<td class="actions">',t+='<div class="array_actions">',e.indexOf("array-add")>-1&&(t+='<a class="array_row_add" href="#">',t+=`<span class="${this.icon_add}"> </span>`,t+="</a>"),e.indexOf("array-remove")>-1&&(t+='<a class="array_row_remove" href="#">',t+=`<span class="${this.icon_remove}"> </span>`,t+="</a>"),e.indexOf("array-sort")>-1&&(t+='<a class="array_row_up" href="#">',t+=`<span class="${this.icon_up}"> </span>`,t+="</a>",t+='<a class="array_row_down" href="#">',t+=`<span class="${this.icon_down}"> </span>`,t+="</a>"),t+="</div>",t+="</td>"),t+="</tr>",t=r(t);let i=r("> .arraytemplate",this.wrapper).clone();return r(".widget",t).append(i.children()),t}get_row(e){return r(e).parent().parent().parent()}get base_id(){let e=this.wrapper.attr("id");return e.substring(6,e.length)}trigger(e,...r){let t=this.hooks[e.substring(3,e.length)];if(Object.entries(t).length){console.log("Array hooks are deprecated. Use ``on_array_event`` instead.");for(let e in t)console.log(`    - ${e}`),t[e].apply(null,r)}r.splice(0,0,this);for(let t of this._array_subscribers[e])t.apply(null,r)}reset_indices(e){let t,i=0,a=this.base_id,s=this;e.children().each((function(){t=r(this),s.set_row_index(t,a,i),s.trigger("on_index",t,i),i++})),this.bind_actions()}set_row_index(e,t,i){let a,s=t.replace(/\-/g,"."),n=this.set_attr_index.bind(this),o=this;e.children().each((function(){a=r(this),n(a,"id",t,i,"-"),n(a,"for",t,i,"-"),n(a,"name",s,i,"."),o.set_row_index(a,t,i)}))}set_attr_index(e,r,t,i,a){let s=e.attr(r);s&&s.indexOf(t)>-1&&e.attr(r,this.set_value_index(s,t,i,a))}set_value_index(e,r,t,i){let a=e.indexOf(r)+r.length+1,s=e.indexOf(i,a),n=e.substring(0,a),o="";return s>-1&&(o=e.substring(s,e.length)),n+t+o}init_row(e,r){this.reset_indices(e),this.array_widget.initialize(r),this.trigger("on_add",r)}add_first_handle(e){e.preventDefault();let t=this.create_row(),i=r("> tbody",this.table);this.trigger("on_before_add",t,i),i.prepend(t),this.init_row(i,t)}add_handle(e){e.preventDefault();let r=this.get_row(e.currentTarget),t=this.create_row(),i=r.parent();this.trigger("on_before_add",t,i),r.after(t),this.init_row(i,t)}remove_handle(e){e.preventDefault();let r=this.get_row(e.currentTarget);this.trigger("on_remove",r);let t=r.parent();r.remove(),this.reset_indices(t)}up_handle(e){e.preventDefault();let r=this.get_row(e.currentTarget);this.trigger("on_before_up",r),r.insertBefore(r.prev()),this.reset_indices(r.parent()),this.trigger("on_up",r)}down_handle(e){e.preventDefault();let r=this.get_row(e.currentTarget);this.trigger("on_before_down",r),r.insertAfter(r.next()),this.reset_indices(r.parent()),this.trigger("on_down",r)}}let i={before_add:{},add:{},remove:{},before_up:{},up:{},before_down:{},down:{},index:{}},a={on_before_add:[],on_add:[],on_remove:[],on_before_up:[],on_up:[],on_before_down:[],on_down:[],on_index:[]};class s extends t{static initialize(e){r("div.array",e).each((function(){let e=r(this);-1===e.attr("id").indexOf("-TEMPLATE")&&new s(e)}))}constructor(e){super(e),this.hooks=i,this._array_subscribers=a,this.array_widget=s,this.icon_add="bi-plus-circle-fill",this.icon_remove="bi-dash-circle-fill",this.icon_up="bi-arrow-up-circle-fill",this.icon_down="bi-arrow-down-circle-fill"}up_handle(e){super.up_handle(e);const r=this.get_row(e.currentTarget);this.highlight(r)}down_handle(e){super.down_handle(e);const r=this.get_row(e.currentTarget);this.highlight(r)}create_row(){const e=super.create_row();return this.highlight(e),e}highlight(e){e.addClass("row-moved"),setTimeout((()=>{e.removeClass("row-moved")}),1e3)}}return r((function(){void 0!==window.ts?ts.ajax.register(s.initialize,!0):void 0!==window.bdajax?bdajax.register(s.initialize,!0):s.initialize()})),e.ArrayWidget=s,e.hooks=i,e.inside_template=function(e){return e.parents(".arraytemplate").length>0},e.on_array_event=function(e,r){a[e].push(r)},Object.defineProperty(e,"__esModule",{value:!0}),window.yafowil=window.yafowil||{},window.yafowil.array=e,e}({},jQuery);
