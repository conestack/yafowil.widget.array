var yafowil_array=function(e,r){"use strict";let t={before_add:{},add:{},remove:{},before_up:{},up:{},before_down:{},down:{},index:{}},a={on_before_add:[],on_add:[],on_remove:[],on_before_up:[],on_up:[],on_before_down:[],on_down:[],on_index:[]};class i{static initialize(e){r("div.array",e).each((function(){let e=r(this);-1===e.attr("id").indexOf("-TEMPLATE")&&new i(e)}))}constructor(e){e.data("yafowil-array",this),this.wrapper=e;let t=r("> table",e),a=r("> thead .array_actions",t),i=this.add_first_handle.bind(this);this.table=t,r("a.array_row_add",a).off().on("click",i),this.bind_actions()}bind_actions(){let e=r("> tbody > tr > td.actions .array_actions",this.table),t=this.add_handle.bind(this),a=this.remove_handle.bind(this),i=this.up_handle.bind(this),n=this.down_handle.bind(this);this.mark_disabled(e),r("a.array_row_add",e).off().on("click",t),r("a.array_row_remove",e).off().on("click",a),r("a.array_row_up",e).off().on("click",i),r("a.array_row_down",e).off().on("click",n)}mark_disabled(e){r("a.array_row_up",e).removeClass("array_row_up_disabled").first().addClass("array_row_up_disabled"),r("a.array_row_down",e).removeClass("array_row_down_disabled").last().addClass("array_row_down_disabled")}create_row(){let e=this.wrapper.attr("class"),t="";t+="<tr>",t+='<td class="widget">',t+="</td>",-1===e.indexOf("array-static")&&(t+='<td class="actions">',t+='<div class="array_actions">',e.indexOf("array-add")>-1&&(t+='<a class="array_row_add" href="#">',t+='<span class="icon-plus-sign"> </span>',t+="</a>"),e.indexOf("array-remove")>-1&&(t+='<a class="array_row_remove" href="#">',t+='<span class="icon-minus-sign"> </span>',t+="</a>"),e.indexOf("array-sort")>-1&&(t+='<a class="array_row_up" href="#">',t+='<span class="icon-circle-arrow-up"> </span>',t+="</a>",t+='<a class="array_row_down" href="#">',t+='<span class="icon-circle-arrow-down"> </span>',t+="</a>"),t+="</div>",t+="</td>"),t+="</tr>",t=r(t);let a=r("> .arraytemplate",this.wrapper).clone();return r(".widget",t).append(a.children()),t}get_row(e){return r(e).parent().parent().parent()}get base_id(){let e=this.wrapper.attr("id");return e.substring(6,e.length)}trigger(e,...r){let i=t[e.substring(3,e.length)];if(Object.entries(i).length){console.log("Array hooks are deprecated. Use ``on_array_event`` instead.");for(let e in i)console.log(`    - ${e}`),i[e].apply(null,r)}r.splice(0,0,this);for(let t of a[e])t.apply(null,r)}reset_indices(e){let t,a=0,i=this.base_id,n=this;e.children().each((function(){t=r(this),n.set_row_index(t,i,a),n.trigger("on_index",t,a),a++})),this.bind_actions()}set_row_index(e,t,a){let i,n=t.replace(/\-/g,"."),s=this.set_attr_index.bind(this),o=this;e.children().each((function(){i=r(this),s(i,"id",t,a,"-"),s(i,"for",t,a,"-"),s(i,"name",n,a,"."),o.set_row_index(i,t,a)}))}set_attr_index(e,r,t,a,i){let n=e.attr(r);n&&n.indexOf(t)>-1&&e.attr(r,this.set_value_index(n,t,a,i))}set_value_index(e,r,t,a){let i=e.indexOf(r)+r.length+1,n=e.indexOf(a,i),s=e.substring(0,i),o="";return n>-1&&(o=e.substring(n,e.length)),s+t+o}init_row(e,r){this.reset_indices(e),i.initialize(r),this.trigger("on_add",r)}add_first_handle(e){e.preventDefault();let t=this.create_row(),a=r("> tbody",this.table);this.trigger("on_before_add",t,a),a.prepend(t),this.init_row(a,t)}add_handle(e){e.preventDefault();let r=this.get_row(e.currentTarget),t=this.create_row(),a=r.parent();this.trigger("on_before_add",t,a),r.after(t),this.init_row(a,t)}remove_handle(e){e.preventDefault();let r=this.get_row(e.currentTarget);this.trigger("on_remove",r);let t=r.parent();r.remove(),this.reset_indices(t)}up_handle(e){e.preventDefault();let r=this.get_row(e.currentTarget);this.trigger("on_before_up",r),r.insertBefore(r.prev()),this.reset_indices(r.parent()),this.trigger("on_up",r)}down_handle(e){e.preventDefault();let r=this.get_row(e.currentTarget);this.trigger("on_before_down",r),r.insertAfter(r.next()),this.reset_indices(r.parent()),this.trigger("on_down",r)}}return r((function(){void 0!==window.ts?ts.ajax.register(i.initialize,!0):void 0!==window.bdajax?bdajax.register(i.initialize,!0):i.initialize()})),e.ArrayWidget=i,e.hooks=t,e.inside_template=function(e){return e.parents(".arraytemplate").length>0},e.on_array_event=function(e,r){a[e].push(r)},Object.defineProperty(e,"__esModule",{value:!0}),window.yafowil=window.yafowil||{},window.yafowil.array=e,e}({},jQuery);
